Bootstrap: docker
From: nvidia/cuda:11.0.3-cudnn8-devel-ubuntu18.04

%labels
    MAINTAINER Vladyslav Zlochevskyi
    VERSION v1.0

%environment
    export LC_ALL=C
    export PYTHONPATH=/opt/project
    export CUDA_HOME=/usr/local/cuda
    export PATH=/usr/local/cuda/bin:/root/.local/bin:$PATH
    export LD_LIBRARY_PATH=/usr/local/cuda/lib64:$LD_LIBRARY_PATH

%post
    # Set bash as default shell
    SHELL=/bin/bash
    echo "SHELL=/bin/bash" >> /etc/environment

    # Add bash environment variables
    echo "alias py=python3 lf=ranger" >> /.bashrc

    echo "System updates and basic dependencies..."
    apt-get update && apt-get upgrade -y
    # Add deadsnakes PPA to get access to multiple Python versions
    apt-get install -y software-properties-common curl
    apt-get update

    # First ensure https repository support is available
    apt-get install -y apt-transport-https ca-certificates

    # Add deadsnakes PPA
    apt-get install -y 
    DEBIAN_FRONTEND=noninteractive apt-add-repository -y ppa:deadsnakes/ppa
    apt-get update

    # Install Python versions
    echo "\nNow install Python 3.9 and other dependencies..."
    DEBIAN_FRONTEND=noninteractive apt-get install -y \
        python3.9 \
        python3.9-dev \
        python3.9-distutils \
        python3-pip
    
    apt-get install -y \
        build-essential \
        git \
        wget \
        libgl1-mesa-glx \
        libglib2.0-0 \
        fonts-firacode

    echo "Update alternatives to use Python 3.8..."
    update-alternatives --install /usr/bin/python3 python3 /usr/bin/python3.9 1

    echo "Upgrade pip..."
    python3 -m pip install --upgrade pip

    # Install Poetry
    curl -sSL https://install.python-poetry.org | python3 -

    # Add Poetry to PATH
    export PATH="/root/.local/bin:$PATH"

    # Configure Poetry
    poetry config virtualenvs.create false

    # Add optional software

    # Starship installation

    # Install Rust (required for Starship)
    curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
    . $HOME/.cargo/env

    # Install Starship
    curl -sS https://starship.rs/install.sh | sh -s -- --yes

    # Set up Starship in bash
    echo 'eval "$(starship init bash)"' >> /.bashrc

    # Create default Starship configuration
    mkdir -p /.config
    cat > /.config/starship.toml << 'EOF'
    # Starship configuration
    add_newline = true

    [line_break]
    disabled = false

    [character]
    success_symbol = "[âžœ](bold green)"
    error_symbol = "[âœ—](bold red)"

    [python]
    symbol = "ðŸ "
    pyenv_version_name = true

    [cuda]
    symbol = "ðŸš€ "
    format = "[$symbol$version]($style) "
EOF
    # Install ranger file manager and dependencies
    apt-get install -y ranger highlight caca-utils w3m poppler-utils


    # TODO: Add specific entry points/scripts
    
%runscript
    python3 "$@"

# TODO: Add bind points for data mounting
# TODO: Move installation of requirements to correponding repo directories
