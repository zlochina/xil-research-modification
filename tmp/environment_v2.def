Bootstrap: docker
From: nvidia/cuda:11.0.3-cudnn8-devel-ubuntu18.04

%labels
    MAINTAINER Vladyslav Zlochevskyi
    VERSION v1.0

%environment
    export LC_ALL=C
    export PYTHONPATH=/opt/project
    export CUDA_HOME=/usr/local/cuda
    export PATH=/usr/local/cuda/bin:$PATH
    export LD_LIBRARY_PATH=/usr/local/cuda/lib64:$LD_LIBRARY_PATH

%post
    # Set bash as default shell
    SHELL=/bin/bash
    echo "SHELL=/bin/bash" >> /etc/environment

    echo "System updates and basic dependencies..."
    apt-get update && apt-get upgrade -y
    
    echo "\nNow install Python 3.7 and other dependencies..."
    apt-get install -y \
        python3.7 \
        python3.7-dev \
        python3-pip \
        build-essential \
        git \
        wget \
        libgl1-mesa-glx \
        libglib2.0-0
    # TODO: Add more system dependencies as needed

    echo "Update alternatives to use Python 3.7..."
    update-alternatives --install /usr/bin/python3 python3 /usr/bin/python3.7 1

    echo "Upgrade pip..."
    python3 -m pip install --upgrade pip

    # Install common requirements first (shared between projects)
    pip3 install \
        scikit-image==0.15.0 \
        scikit-learn==0.20.3 \
        seaborn==0.9.0

    # Add optional software

    # Starship installation

    # Install Rust (required for Starship)
    apt-get install -y curl
    curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
    . $HOME/.cargo/env

    # Install Starship
    curl -sS https://starship.rs/install.sh | sh -s -- --yes

    # Install a Nerd Font (Optional, but recommended for full functionality)
    apt-get install -y fonts-firacode

    # Set up Starship in bash
    echo 'eval "$(starship init bash)"' >> /.bashrc

    # Create default Starship configuration
    mkdir -p /.config
    cat > /.config/starship.toml << 'EOF'
    # Starship configuration
    add_newline = true

    [line_break]
    disabled = false

    [character]
    success_symbol = "[âžœ](bold green)"
    error_symbol = "[âœ—](bold red)"

    [python]
    symbol = "ðŸ "
    pyenv_version_name = true

    [cuda]
    symbol = "ðŸš€ "
    format = "[$symbol$version]($style) "
EOF
    # Install ranger file manager and dependencies
    apt-get install -y ranger highlight caca-utils w3m poppler-utils


    # TODO: Add specific entry points/scripts
    
%runscript
    python3 "$@"

# TODO: Add bind points for data mounting
# TODO: Move installation of requirements to correponding repo directories
